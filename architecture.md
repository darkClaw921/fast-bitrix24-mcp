### Архитектура проекта

Проект представляет собой MCP-сервер для работы с Bitrix24 (REST) на базе `fastmcp`, с агрегирующим сервером, который монтирует подсервера с инструментами (tools), ресурсами (resources) и промптами (prompts).

### Корневая структура
- `fast_bitrix24_mcp/`: пакет с кодом серверов MCP
- `main.py`: точка запуска, импортирует `mcp` из `fast_bitrix24_mcp.main` и стартует сервер
- `ui.py`: FastAPI приложение с веб-интерфейсом для тестирования всех tools MCP сервера. Предоставляет UI для выбора tool, ввода параметров и просмотра результатов выполнения. Использует `langchain_mcp_adapters.client.MultiServerMCPClient` для подключения к MCP серверу и вызова tools. **Транспорт**: по умолчанию используется `streamable_http`, настраивается через переменную окружения `MCP_TRANSPORT`. Поддерживает заголовки авторизации для транспортов `streamable_http`, `sse` и `http`. **CORS**: настроен для работы с любыми источниками (для разработки). **JavaScript**: использует современный подход с `addEventListener` вместо `onclick`, экранирование HTML для безопасности, подробное логирование в консоль браузера для отладки. **Секундомер времени выполнения**: измеряет время выполнения запросов на сервере (Python `time.perf_counter()`) и на клиенте (JavaScript `performance.now()`), отображает оба значения в UI. Время выполнения запроса возвращается в поле `execution_time` ответа API и логируется через `loguru`. Логирование через `loguru` в файлы `logs/ui_{time}.log`
- `README.md`: документация по установке и использованию
- `pyproject.toml`: метаданные и зависимости проекта
- `uv.lock`: lock-файл зависимостей
- `CHANGELOG.md`: журнал изменений
- `example_chats/`: примеры сценариев (диалогов)
- `test_mcp.py`, `mcp_test.py`: утилиты/скрипты для проверки/демонстрации работы
- `analyze_file.py`: скрипт командной строки для анализа экспортированных JSON файлов. Поддерживает операции count, sum, avg, min, max с фильтрацией по условиям и группировкой по полям
- `exports/`: папка для экспортированных JSON файлов
- `cache/`: папка для файлового кэша запросов к Bitrix24 API (TTL 1 час, создается автоматически)
- `logs/`: папка для логов приложения (создается автоматически)

### Пакет `fast_bitrix24_mcp`

- `fast_bitrix24_mcp/main.py`
  - Агрегирующий сервер MCP с именем `bitrix24-main`.
  - Регистрирует главный промпт `main_prompt`.
  - Монтирует подсервера:
    - `userfields` → `resources/userfields.py`
    - `promts` → `promts/promts.py`
    - `deal` → `tools/deal.py`
    - `fields` → `tools/userfields.py`
    - `task` → `tools/task.py`
    - `user` → `tools/user.py`
    - `activity_decline` → `tools/activity_decline.py`
    - `daily_summary` → `tools/daily_summary.py`
    - `sales_funnel` → `tools/sales_funnel.py`
    - `top_clients` → `tools/top_clients.py`
    - `inactive_clients` → `tools/inactive_clients.py`
    - `manager_support` → `tools/manager_support.py`

- `fast_bitrix24_mcp/tools/userfields.py`
  - Сервер MCP с именем `userfields`.
  - Инструменты:
    - `get_all_info_fields(entity: list[str] = ['all'], isText: bool = True)` — получение ID/названий/типов полей CRM (`deal`, `contact`, `company`, `task`), включая развёрнутые значения для `enumeration`. Может возвращать текст или словарь; сохраняет выгрузки в файлы `bitrix_fields_{entity}.json`.

- `fast_bitrix24_mcp/tools/deal.py`
  - Сервер MCP с именем `bitrix24`.
  - Инструменты:
    - `list_deal(filter_fields: dict[str, str] = {}, fields_id: list[str] = ["ID", "TITLE"])` — выборка сделок по фильтрам с возможностью вернуть все или указанные поля; вывод в человеко-читаемом виде (в том числе значения `enumeration`).
    - `get_stages(entity_id: str = "DEAL_STAGE")` — получение стадий в человекочитаемом виде, сгруппированных по воронкам. Для стадий сделок (`DEAL_STAGE`) получает все воронки и группирует стадии по воронкам в формате `{category_id: {name: "Название воронки", stages: {STATUS_ID: "название стадии"}}}`. Для других типов сущностей (`LEAD_STATUS`, `QUOTE_STATUS` и т.д.) возвращает плоский словарь со всеми стадиями.
    - `get_stage_history_human(entity_type_id: int, owner_id: int = None, from_date: str = None, to_date: str = None)` — получение истории движения по стадиям в человекочитаемом виде с расчетом времени нахождения в каждой стадии. Поддерживает типы сущностей: 1 - лид, 2 - сделка, 5 - счет старый, 31 - счет новый. **Фильтрация по датам**: параметры `from_date` и `to_date` позволяют ограничить период анализа (формат YYYY-MM-DD или YYYY-MM-DDTHH:MM:SS). Если указана только дата без времени, автоматически добавляется начало/конец дня (00:00:00 для `from_date`, 23:59:59 для `to_date`). **Два режима работы**: если `owner_id` указан, возвращает детальную историю для конкретного объекта с указанием типа события (создание, переход на стадию, смена воронки), названия стадии, даты/времени перехода и времени нахождения в стадии; если `owner_id` не указан, возвращает агрегированную статистику по всем сущностям указанного типа: среднее время нахождения в каждой стадии, количество переходов и общее время. Стадии сортируются по среднему времени (от большего к меньшему). Текущие стадии (последние записи) исключаются из статистики, так как время нахождения в них еще не завершено.
    - `get_deals_at_risk(filter_fields: dict[str, str] = {}, fields_id: list[str] = ["ID", "TITLE", "STAGE_ID", "DATE_MODIFY"], include_comments: bool = True, exclude_funnel_keyword: str = None)` — получение сделок, находящихся в риске. **Критерии риска**: сделка считается «в риске», если выполняется одно или несколько условий: статус сделки не менялся более 5 рабочих дней (исключая субботу и воскресенье); отсутствует активность (звонки, комментарии, задачи) более 3 дней. **Параметр include_comments**: если `False`, получение комментариев пропускается для ускорения работы (по умолчанию `True`). **Параметр exclude_funnel_keyword**: если указано ключевое слово, все воронки, в названии которых содержится это слово (без учета регистра), будут исключены из анализа. Сделки из этих воронок не будут проверяться. Функция получает список всех воронок через `get_deal_categories()`, находит воронки с указанным ключевым словом в названии и фильтрует сделки на клиенте, исключая те, у которых `CATEGORY_ID` совпадает с ID исключаемых воронок. **Обязательные поля**: функция всегда добавляет поле `CATEGORY_ID` в `fields_id` для получения информации о воронке каждой сделки. **Вывод**: возвращает текстовый отчет со списком сделок в риске, где для каждой сделки указывается название воронки, стадия, причины риска и статистика активности за последние 3 дня. **Проверка активности**: активность проверяется для всех сделок батчами через `_get_all_deals_activity_batch` (оптимизированная версия). Получает все активности CRM одним запросом с фильтром по дате, комментарии батчами для всех сделок (если `include_comments=True`), задачи один раз за период. Затем группирует результаты по сделкам на клиенте. Это значительно ускоряет работу при большом количестве сделок: вместо N*3 запросов (где N - количество сделок) выполняется всего 3 запроса (активности CRM, комментарии батчами, задачи). **Логирование**: добавлено подробное логирование для отладки проблем с подсчетом дел в таймлайне (логируется количество полученных активностей, группировка по сделкам, значения для каждой сделки), а также логирование исключаемых воронок при использовании `exclude_funnel_keyword`. **Вспомогательные функции**: `_count_workdays(start_date, end_date)` — подсчет рабочих дней между двумя датами (исключая выходные); `_get_deal_activity(deal_id, days=3)` — получение активности по одной сделке за указанный период с возвратом информации о звонках, комментариях, задачах и дате последней активности (используется для единичных запросов); `_get_all_deals_activity_batch(deal_ids, days=3, include_comments=True)` — получение активности для всех сделок батчами (оптимизированная версия для массовых запросов). **Подсчет дел в таймлайне**: дела в таймлайне (`deals`) - это все активности CRM разных типов (TYPE_ID = 1: Встреча, TYPE_ID = 2: Звонок, TYPE_ID = 3: Задача, TYPE_ID = 4: Письмо, TYPE_ID = 5: Действие, TYPE_ID = 6: Пользовательское действие), которые связаны со сделкой через поле `ENTITY_ID` и попадают в период последних N дней (по умолчанию 3 дня) по дате создания (`CREATED`).
    - `export_entities_to_json(entity: str, filter_fields: dict = {}, select_fields: list[str] = ["*"], filename: str | None = None)` — экспорт элементов сущности (`deal`/`contact`/`company`) по фильтру в JSON-файл в `exports/`; ответ содержит сущность, количество и путь к файлу.
    - `analyze_export_file(file_path: str, operation: str, fields: str | list[str] | None = None, condition: str | dict | None = None, group_by: list[str] | None = None)` — операции над JSON: `count`, `sum`, `avg`, `min`, `max`; поддерживает условие (например, `"CLOSED == 'N' and ID > 2"`) и группировку по полям (`group_by`).
  - Вспомогательные функции:
    - `prepare_deal_fields_to_humman_format(fields: dict, all_info_fields: dict)` — преобразование технических ключей полей в человеко-читаемые названия и значений перечислений в текст.
    - `_format_timedelta(delta: timedelta)` — форматирование timedelta в человекочитаемый вид (секунды, минуты, часы, дни).
    - `_parse_datetime_from_bitrix(dt_str: str)` — парсинг даты/времени из формата Bitrix24 (ISO-8601 или YYYY-MM-DD HH:MM:SS).
    - `_count_workdays(start_date: datetime, end_date: datetime)` — подсчет рабочих дней между двумя датами (исключая субботу и воскресенье). Используется для проверки критерия риска "статус не менялся более 5 рабочих дней".
    - `_get_deal_activity(deal_id: int, days: int = 3)` — получение активности по одной сделке за указанный период. Проверяет наличие звонков (через `get_crm_activities_by_filter`), комментариев (через `crm.timeline.comment.list`) и задач (через `get_tasks_by_filter` с проверкой поля `UF_CRM_TASK`). Возвращает словарь с информацией о наличии активности, дате последней активности и количестве активностей каждого типа. Используется для единичных запросов активности.
    - `_get_all_deals_activity_batch(deal_ids: list[int], days: int = 3, include_comments: bool = True)` — получение активности для всех сделок батчами (оптимизированная версия для массовых запросов). Получает все активности CRM одним запросом с фильтром по дате и типу сущности (`ENTITY_TYPE='DEAL'`), затем группирует по сделкам на клиенте. **Параметр include_comments**: если `False`, получение комментариев пропускается для ускорения работы (по умолчанию `True`). **Группировка активностей**: активности группируются по сделкам через поле `OWNER_ID` (при `OWNER_TYPE_ID='2'` - сделка), если `OWNER_ID` отсутствует или `OWNER_TYPE_ID` не равен '2', используется `ENTITY_ID` как fallback. Это исправляет проблему, когда активности связаны со сделкой через `OWNER_ID`, а не через `ENTITY_ID`. **Подсчет задач**: учитывает как задачи из модуля задач (через `get_tasks_by_filter` с проверкой поля `UF_CRM_TASK`), так и активности CRM с `PROVIDER_ID='CRM_TODO'` и `PROVIDER_TYPE_ID='TODO'` (TYPE_ID='6'), которые классифицируются как задачи. Получает комментарии батчами для всех сделок через `crm.timeline.comment.list` (fast-bitrix24 автоматически разбивает запросы на батчи по 50), если `include_comments=True`. Возвращает словарь `{deal_id: activity_info}` для всех сделок. Используется в `get_deals_at_risk` для оптимизации работы при большом количестве сделок.
    - `_parse_datetime(value)` — парсинг дат/времени: ISO-8601, `YYYY-MM-DD`, `YYYY-MM-DD HH:MM:SS`.
    - `_keyword_to_datetime(keyword, tz)` — преобразование ключевых слов `today`/`tomorrow`/`yesterday` в начало соответствующего дня с учётом TZ.
    - `_compare(lhs, op, rhs)` — сравнение чисел, дат/времени и строк; для дат поддерживаются операторы `>`, `>=`, `<`, `<=` и ключевые слова `today`/`tomorrow`/`yesterday`.
  - Особенности `analyze_export_file`:
    - Условие в виде строки разбирается парсером: поддерживаются `and`/`or`, операторы `==`, `!=`, `>`, `>=`, `<`, `<=`, `=` (как `==`).
    - Для дат можно писать: `"DATE_CREATE >= today and DATE_CREATE < tomorrow"` или использовать точные ISO-строки.
  - Использует `orm-bitrix24` (`Deal.get_manager(bitrix)`) и тул `get_all_info_fields` из `tools/userfields.py`.

- `fast_bitrix24_mcp/tools/lead.py`
  - Сервер MCP с именем `lead`.
  - Инструменты:
    - `list_lead(filter_fields: dict[str, any] = {}, fields_id: list[str] = ["ID", "TITLE"])` — выборка лидов по фильтрам, поддержка `*` и `select`, форматирование полей в человеко-читаемом виде (включая `enumeration`).
  - Вспомогательные детали:
    - Получение схемы полей лида через `crm.lead.fields` с унификацией структуры под `prepare_fields_to_humman_format`.
    - Экспорт лидов поддерживается через общий инструмент `export_entities_to_json(entity="lead", ...)` из `tools/helper.py`.

- `fast_bitrix24_mcp/tools/user.py`
  - Сервер MCP с именем `users`.
  - Инструменты:
    - `list_user(filter_fields: dict[str, str] = {})` — список пользователей с фильтрацией и форматированием полей в человеко-читаемом виде.
    - `get_user_activity(manager_id: int, days: int = 30)` — получение полной активности пользователя за указанный период. Возвращает детальную статистику: звонки (входящие, исходящие, пропущенные), встречи, email-сообщения, задачи (всего, завершено, в работе), сделки (создано, выиграно), лиды (создано, конвертировано), события календаря, комментарии во всех сущностях CRM. **Оптимизация**: использует оптимизированную версию `get_manager_full_activity()`, которая выполняет все независимые запросы параллельно через `asyncio.gather` (активности CRM, задачи, сделки, лиды, события календаря и комментарии выполняются одновременно) и получает комментарии батчами через `get_all_comments_batch()` вместо 4 отдельных запросов для каждого типа сущности (deal, lead, contact, company). Это значительно ускоряет работу функции.
    - `get_all_managers_activity_report(days: int = 30, include_inactive: bool = True, only_inactive: bool = False)` — получение активности всех менеджеров за указанный период. Возвращает общую статистику по всем менеджерам, список активных менеджеров с детальной статистикой и список неактивных менеджеров (без активности за период). **Параметр only_inactive**: если `True`, возвращает только список неактивных менеджеров без детальной статистики активных, что ускоряет работу. **Кэширование**: результаты кэшируются на 1 час. **Оптимизация**: использует оптимизированную версию `get_all_managers_activity()`, которая получает все сущности за период один раз и группирует их по менеджерам на клиенте. **Батчинг комментариев и параллельные запросы календаря**: комментарии получаются батчами для всех менеджеров одновременно через функцию `get_all_comments_batch()`, события календаря получаются параллельно через `get_all_calendar_events_batch()` (API Bitrix24 не поддерживает батчинг для методов календаря), что значительно ускоряет работу при большом количестве менеджеров (вместо N*5 последовательных запросов выполняется несколько батчей для комментариев и параллельные запросы для календаря).

- `fast_bitrix24_mcp/tools/activity_decline.py`
  - Сервер MCP с именем `activity_decline`.
  - Инструменты:
    - `get_managers_with_declined_activity(isText: bool = False)` — выявление менеджеров со сниженной активностью (оптимизированная версия с батчами). **Критерии снижения активности**: менеджер считается снизившим активность, если за последние 7 дней у него количество задач упало на 30%+ по сравнению с предыдущей неделей (8-14 дней назад) или количество звонков снизилось на 25%+. **Параметр isText**: если `True`, возвращает человекочитаемый текст с информацией о менеджерах со сниженной активностью; если `False` (по умолчанию), возвращает структурированный словарь с данными. **Периоды анализа**: текущая неделя (последние 7 дней) и предыдущая неделя (8-14 дней назад). **Оптимизация**: получает все данные одним набором запросов вместо последовательных вызовов для каждого менеджера. Получает все звонки за период (14 дней) одним запросом через `get_crm_activities_by_filter` с фильтром по дате и типу (TYPE_ID = 2), все задачи за период одним запросом через `get_tasks_by_filter` с фильтром по дате создания, затем группирует данные на клиенте по менеджерам и неделям. Это значительно ускоряет работу при большом количестве менеджеров: вместо N*4 запросов (где N - количество менеджеров) выполняется всего 2 запроса. **Возвращаемые данные**: если `isText=False` — словарь с информацией о периоде анализа, списком менеджеров со сниженной активностью (с указанием причин снижения, процентов падения и сравнением показателей за обе недели) и общей статистикой (количество проверенных менеджеров и количество с выявленным снижением); если `isText=True` — человекочитаемый текст с форматированным списком менеджеров, их показателями за обе недели, процентами снижения и причинами. **Вспомогательные функции**: `_parse_datetime_from_bitrix(dt_str)` — парсинг даты/времени из формата Bitrix24 для корректного определения принадлежности активности к неделе.

- `fast_bitrix24_mcp/tools/daily_summary.py`
  - Сервер MCP с именем `daily_summary`.
  - Инструменты:
    - `get_daily_summary(date: str = None, group_by_managers: bool = False, isText: bool = False)` — получение сводки по итогам дня (оптимизированная версия с батчами). **Сводка включает**: количество новых лидов и сделок, количество созданных и выполненных задач, количество звонков (входящих/исходящих). **Параметр date**: дата для сводки в формате YYYY-MM-DD. Если не указана, используется сегодняшний день (московское время). **Параметр group_by_managers**: если `True`, возвращает сводку с группировкой по менеджерам; если `False` (по умолчанию), возвращает общую сводку. **Параметр isText**: если `True`, возвращает человекочитаемый текст; если `False` (по умолчанию), возвращает структурированный словарь. **Оптимизация**: получает все данные параллельно одним набором запросов через `asyncio.gather` (лиды, сделки, задачи, звонки запрашиваются одновременно), затем группирует данные на клиенте. Это значительно ускоряет работу: вместо 4 последовательных запросов выполняется 4 параллельных запроса. **Определение дня**: используется московское время (Europe/Moscow) для определения границ дня (00:00:00 - 23:59:59), затем конвертируется в UTC для запросов к API. **Группировка по менеджерам**: при `group_by_managers=True` группирует данные по полям: лиды по `CREATED_BY`, сделки по `ASSIGNED_BY_ID`, задачи по `RESPONSIBLE_ID`, звонки по `RESPONSIBLE_ID`. Выполненные задачи определяются по статусу `STATUS='5'`. Входящие звонки определяются по `DIRECTION='2'`, исходящие по `DIRECTION='1'`. **Возвращаемые данные**: если `group_by_managers=False` и `isText=False` — словарь с общей сводкой (date, leads.new, deals.new, tasks.created/completed, calls.total/incoming/outgoing); если `group_by_managers=True` и `isText=False` — словарь с общей сводкой и списком менеджеров с их показателями; если `isText=True` — человекочитаемый текст с форматированной сводкой. **Вспомогательные функции**: `_normalize_optional_date(date_value)` — нормализация опционального параметра даты (преобразует строки 'null', 'None', пустые строки в None для корректной обработки параметров, переданных как строки 'null' вместо None); `_parse_datetime_from_bitrix(dt_str)` — парсинг даты/времени из формата Bitrix24 для корректной обработки данных.

- `fast_bitrix24_mcp/tools/sales_funnel.py`
  - Сервер MCP с именем `sales_funnel`.
  - Инструменты:
    - `get_sales_funnel(from_date: str = None, to_date: str = None, isText: bool = False)` — построение воронки продаж за период (оптимизированная версия с батчами). **Воронка показывает**: количество созданных лидов, количество конвертированных лидов в сделки, количество сделок по стадиям, количество выигранных сделок, конверсию по стадиям. **Параметр from_date**: начало периода в формате YYYY-MM-DD. Если не указана, используется начало текущего месяца (московское время). **Параметр to_date**: конец периода в формате YYYY-MM-DD. Если не указана, используется конец текущего месяца (московское время). **Параметр isText**: если `True`, возвращает человекочитаемый текст; если `False` (по умолчанию), возвращает структурированный словарь. **Оптимизация**: получает все данные одним набором запросов вместо последовательных вызовов. Получает все лиды за период одним запросом через `get_leads_by_filter` с фильтром по дате создания (`>=DATE_CREATE`, `<=DATE_CREATE`), все сделки за период одним запросом через `get_deals_by_filter` с фильтром по дате создания, информацию о стадиях через `get_deal_stages` и `get_deal_categories`, затем группирует данные на клиенте. Это значительно ускоряет работу: вместо множественных запросов выполняется всего несколько запросов (лиды, сделки, стадии). **Определение периода**: используется московское время (Europe/Moscow) для определения границ периода, затем конвертируется в UTC для запросов к API. **Подсчет конверсии**: конвертированные лиды определяются по полю `STATUS_ID='CONVERTED'`, выигранные сделки определяются по полю `STAGE_ID` содержащему подстроку `'WON'` (без учета регистра). Конверсия лидов рассчитывается как процент конвертированных от общего количества созданных лидов. Конверсия по стадиям рассчитывается как процент сделок на каждой стадии от общего количества созданных сделок. **Возвращаемые данные**: если `isText=False` — словарь с данными воронки (period, leads.total_created/converted/conversion_rate, deals.total_created/won/won_rate/by_stage, funnel); если `isText=True` — человекочитаемый текст с форматированной воронкой продаж. **Вспомогательные функции**: `_normalize_optional_date(date_value)` — нормализация опционального параметра даты (преобразует строки 'null', 'None', пустые строки в None для корректной обработки параметров, переданных как строки 'null' вместо None); `_parse_datetime_from_bitrix(dt_str)` — парсинг даты/времени из формата Bitrix24 для корректной обработки данных.

- `fast_bitrix24_mcp/tools/top_clients.py`
  - Сервер MCP с именем `top_clients`.
  - Инструменты:
    - `get_top_clients_by_deals_sum(n: int = 10, from_date: str = None, to_date: str = None, isText: bool = False)` — получение топ-N клиентов по сумме сделок (оптимизированная версия с батчами). **Функция получает**: все сделки за указанный период (или за все время, если даты не указаны), группирует их по клиентам (контактам или компаниям) и возвращает топ-N клиентов по сумме всех сделок. **Параметр n**: количество клиентов в топе (по умолчанию 10). **Параметр from_date**: начало периода в формате YYYY-MM-DD. Если не указана, фильтр по дате не применяется (получаются все сделки за все время). **Параметр to_date**: конец периода в формате YYYY-MM-DD. Если не указана, фильтр по дате не применяется (получаются все сделки за все время). **Параметр isText**: если `True`, возвращает человекочитаемый текст; если `False` (по умолчанию), возвращает структурированный словарь. **Оптимизация**: получает все данные одним набором запросов вместо последовательных вызовов. Получает все сделки одним запросом через `get_deals_by_filter` с фильтром по дате создания (если даты указаны) или без фильтра (если даты не указаны), затем группирует по клиентам на клиенте. Информация о контактах и компаниях получается параллельно через `get_contacts_by_filter` и `get_companies_by_filter` (без чувствительных данных: email и телефон не запрашиваются). Это значительно ускоряет работу: вместо множественных запросов выполняется всего несколько запросов (сделки, контакты, компании). **Определение периода**: если даты указаны, используется московское время (Europe/Moscow) для определения границ периода, затем конвертируется в UTC для запросов к API. Если даты не указаны, фильтр по дате не применяется и получаются все сделки. **Группировка по клиентам**: приоритет отдается компаниям (если у сделки есть `COMPANY_ID`, используется компания, иначе используется `CONTACT_ID`). Сумма сделок рассчитывается по полю `OPPORTUNITY`. **Возвращаемые данные**: если `isText=False` — словарь с данными топ-N клиентов (period с полями from_date и to_date, которые могут быть None, top_clients с полями rank, client_type, client_id, client_name, total_deals_sum, deals_count, summary с общей статистикой); если `isText=True` — человекочитаемый текст с форматированным списком топ-N клиентов. **Безопасность**: email и телефон не возвращаются в результатах для защиты чувствительной информации. **Вспомогательные функции**: `_normalize_optional_date(date_value)` — нормализация опционального параметра даты (преобразует строки 'null', 'None', пустые строки в None для корректной обработки параметров, переданных как строки 'null' вместо None); `_parse_datetime_from_bitrix(dt_str)` — парсинг даты/времени из формата Bitrix24 для корректной обработки данных.

- `fast_bitrix24_mcp/tools/inactive_clients.py`
  - Сервер MCP с именем `inactive_clients`.
  - Инструменты:
    - `get_clients_without_activity(category_filter: dict[str, str] = None, days: int = 30, isText: bool = False, include_comments: bool = True, include_contacts: bool = True, include_companies: bool = True)` — получение клиентов категории A без активности за указанный период (оптимизированная версия с батчами). **Функция получает**: все контакты и компании с фильтром по категории (пользовательское поле), затем проверяет активность каждого клиента за указанный период. **Параметр category_filter**: фильтр для поиска клиентов по категории (пользовательское поле). Пример: `{"UF_CRM_CATEGORY": "A"}` для контактов или компаний. Если не указан, проверяются все клиенты. **Параметр days**: количество дней без активности (по умолчанию 30). **Параметр isText**: если `True`, возвращает человекочитаемый текст; если `False` (по умолчанию), возвращает структурированный словарь. **Параметр include_comments**: если `False`, получение комментариев пропускается для ускорения работы (по умолчанию `True`). **Параметр include_contacts**: включить контакты в проверку (по умолчанию `True`). **Параметр include_companies**: включить компании в проверку (по умолчанию `True`). Если оба параметра `True`, возвращается общий список клиентов без активности. Если только один параметр `True`, возвращаются только клиенты соответствующего типа. **Проверка активности**: проверяется отсутствие взаимодействий с клиентом более указанного количества дней: звонки (TYPE_ID = 2), письма (TYPE_ID = 4), встречи (TYPE_ID = 1), комментарии, задачи (через поле `UF_CRM_TASK` с форматом "C_123" для контактов и "CO_123" для компаний), сделки (через `CONTACT_ID` или `COMPANY_ID`). **Особенность для компаний**: для компаний дополнительно проверяется активность через их сделки - получаются ВСЕ сделки компании без фильтра по дате создания (так как активность может быть в старой сделке), затем проверяются звонки и задачи по этим сделкам через `_get_all_deals_activity_batch` за указанный период. Это позволяет учитывать активность менеджеров по сделкам компании (включая старые сделки) при определении активности самой компании. **Оптимизация**: получает все данные одним набором запросов вместо последовательных вызовов. Получает все активности CRM одним запросом для контактов и одним запросом для компаний с фильтром по дате (только для включенных типов), комментарии батчами для всех клиентов (если `include_comments=True`), задачи один раз за период, сделки один раз за период. Для компаний дополнительно получает активность по всем их сделкам батчами через `_get_all_deals_activity_batch`. Затем группирует результаты по клиентам на клиенте. Это значительно ускоряет работу при большом количестве клиентов: вместо N*5 запросов (где N - количество клиентов) выполняется несколько запросов (активности CRM, комментарии батчами, задачи, сделки, активность по сделкам компаний). **Возвращаемые данные**: если `isText=False` — словарь с данными клиентов без активности (period с полем days, category_filter, clients_without_activity с полями client_type, client_id, client_name, last_activity_date, activities, summary с общей статистикой); если `isText=True` — человекочитаемый текст с форматированным списком клиентов без активности. **Вспомогательные функции**: `_get_client_activity_batch(contact_ids, company_ids, days, include_comments, include_contacts, include_companies)` — получение активности для всех клиентов батчами (оптимизированная версия для массовых запросов). Получает все активности CRM одним запросом для контактов и одним запросом для компаний с фильтром по дате (только для включенных типов), затем группирует по клиентам на клиенте. Комментарии получаются батчами для всех клиентов через `crm.timeline.comment.list` (fast-bitrix24 автоматически разбивает запросы на батчи по 50), если `include_comments=True` и соответствующий тип клиентов включен. Задачи получаются один раз за период через `get_tasks_by_filter` с проверкой поля `UF_CRM_TASK` (только для включенных типов). Сделки получаются один раз за период через `get_deals_by_filter` с фильтром по дате создания (только для включенных типов). Для компаний дополнительно получает активность по всем их сделкам батчами через `_get_all_deals_activity_batch` из `tools/deal.py` и суммирует звонки и задачи из сделок к активности компании. Возвращает словарь `{client_key: activity_info}` для всех клиентов, где `client_key` имеет формат `'C_{contact_id}'` для контактов или `'CO_{company_id}'` для компаний. `_parse_datetime_from_bitrix(dt_str)` — парсинг даты/времени из формата Bitrix24 для корректной обработки данных.

- `fast_bitrix24_mcp/tools/manager_support.py`
  - Сервер MCP с именем `manager_support`.
  - Инструменты:
    - `get_managers_needing_support(days: int = 30, overdue_tasks_threshold: int = 5, low_activity_threshold: int = 10, low_calls_threshold: int = 5, production_stage_id: str = None, isText: bool = False)` — получение менеджеров, которым нужна помощь или поддержка (оптимизированная версия с батчами). **Критерии поддержки**: менеджер считается нуждающимся в поддержке, если выполняется одно или несколько условий: много просроченных задач (больше или равно `overdue_tasks_threshold`); мало активности (меньше `low_activity_threshold` активностей за период); плохое качество звонков (меньше `low_calls_threshold` звонков за период); нет сделок переданных в производство (если `production_stage_id` указан). **Параметр days**: количество дней для анализа активности (по умолчанию 30). **Параметр overdue_tasks_threshold**: порог количества просроченных задач (по умолчанию 5). Задача считается просроченной, если есть DEADLINE, DEADLINE < текущего времени и статус не завершен (STATUS != '5'). **Параметр low_activity_threshold**: порог низкой активности (по умолчанию 10 активностей). Подсчитываются все активности CRM (звонки, встречи, письма и т.д.). **Параметр low_calls_threshold**: порог низкого количества звонков (по умолчанию 5 звонков). Подсчитываются звонки (TYPE_ID = '2') за период. **Параметр production_stage_id**: ID стадии "передано в производство" для проверки сделок (опционально). Если указан, проверяется наличие сделок менеджера на этой стадии. Если сделок на этой стадии нет, менеджер считается нуждающимся в поддержке. **Параметр isText**: если `True`, возвращает человекочитаемый текст; если `False` (по умолчанию), возвращает структурированный словарь. **Оптимизация**: получает все данные одним набором запросов вместо последовательных вызовов для каждого менеджера. Получает всех активных менеджеров одним запросом через `get_users_by_filter({'ACTIVE': 'Y'})`, все задачи за период одним запросом через `get_tasks_by_filter`, все активности CRM за период одним запросом через `get_crm_activities_by_filter`, все сделки за период одним запросом через `get_deals_by_filter` (если `production_stage_id` указан), затем группирует данные на клиенте по менеджерам. Это значительно ускоряет работу при большом количестве менеджеров: вместо N*4 запросов (где N - количество менеджеров) выполняется всего 3-4 запроса (менеджеры, задачи, активности, сделки). **Возвращаемые данные**: если `isText=False` — словарь с данными менеджеров, нуждающихся в поддержке (period, thresholds, managers_needing_support с полями manager_id, manager_name, manager_email, reasons, metrics, summary); если `isText=True` — человекочитаемый текст с форматированным списком менеджеров, их причинами и метриками. **Вспомогательные функции**: `_get_all_managers_data_batch(days, production_stage_id)` — получение данных всех менеджеров батчами (оптимизированная версия для массовых запросов). Получает всех активных менеджеров, все задачи, активности и сделки за период одним набором запросов, затем группирует по менеджерам на клиенте. Для каждой задачи проверяет просроченность (DEADLINE < текущего времени и STATUS != '5'). Подсчитывает общее количество активностей и звонков для каждого менеджера. Если `production_stage_id` указан, подсчитывает количество сделок на стадии производства для каждого менеджера. Возвращает словарь `{manager_id: manager_data}` для всех менеджеров. `_parse_datetime_from_bitrix(dt_str)` — парсинг даты/времени из формата Bitrix24 для корректной обработки данных.

- `fast_bitrix24_mcp/tools/task.py`
  - Сервер MCP с именем `tasks`.
  - Инструменты для управления задачами: создание, обновление, удаление, получение списка и деталей.
  - Инструменты для работы с комментариями, чеклистами и учётом времени выполнения задач.
  - Поддержка экспорта задач в JSON и их анализа с фильтрацией и группировкой.

- `fast_bitrix24_mcp/resources/userfields.py`
  - Сервер MCP с именем `userfields` (ресурсы):
    - `config://version` — версия ресурса
    - `fields://{entity}` — проксирует к `get_all_info_fields`, возвращает описание полей запрошенной сущности

- `fast_bitrix24_mcp/promts/promts.py`
  - Сервер MCP с именем `PromptServer`.
  - Промпты:
    - `fields_for_entity(entity: list[str] = ['all'], ctx)` — текстовая подсказка по работе с полями CRM и форматам значений (`enumeration`).

- `fast_bitrix24_mcp/tools/math_server.py`
  - Учебный/примерный сервер MCP с базовыми инструментами (`add`, `multiply`), ресурсами и демонстрацией работы `Context`.

- `fast_bitrix24_mcp/tools/main.py`
  - Учебный пример динамического монтирования подпроцессов MCP и вызова инструментов через `Client`.

### Взаимодействие компонентов
- Агрегатор `bitrix24-main` монтирует подсервера как пространства имён (`userfields`, `promts`, `deal`, `task`, `fields`, `user`).
- Клиент может:
  - получать метаданные полей через ресурс `fields://{entity}` (`resources/userfields.py`),
  - вызывать инструменты работы с полями (`tools/userfields.py`), со сделками (`tools/deal.py`), с задачами (`tools/task.py`) и с пользователями (`tools/user.py`),
  - запрашивать промпты (`promts/promts.py`) и использовать главный промпт `main_prompt` (`fast_bitrix24_mcp/main.py`).

### Аутентификация
- Все HTTP-запросы к агрегатору `bitrix24-main` защищены проверкой токена по схеме Bearer.
- Провайдер: `StaticTokenVerifier` (модуль `fastmcp.server.auth.providers.jwt`), инициализируется в `fast_bitrix24_mcp/main.py` с использованием `AUTH_TOKEN`.
- Источник токена: переменная окружения `AUTH_TOKEN` (загрузка через `python-dotenv`).
- Ожидается заголовок `Authorization: Bearer <AUTH_TOKEN>`.
- При отсутствии `AUTH_TOKEN` сервер не запускается.

### Конфигурация окружения
- Переменная окружения `WEBHOOK` — URL вебхука Bitrix24. Загружается через `python-dotenv` (`.env`).
- Зависимости (см. `pyproject.toml`): `fastmcp`, `orm-bitrix24`, `fast-bitrix24`, `langchain-mcp-adapters`, `langchain[openai]`, `langgraph`, `loguru`, `python-dotenv`.

### Примеры и вспомогательные материалы
- `example_chats/deal.md` — примеры запросов/диалогов.
- `README.md` — инструкции по установке/использованию.

- `fast_bitrix24_mcp/tools/helper.py`
  - Сервер MCP с именем `helper`.
  - Вспомогательные функции для экспорта и анализа данных:
    - `export_entities_to_json(entity, filter_fields, select_fields, filename)` — экспорт сущностей (`deal`, `contact`, `company`, `user`, `task`) в JSON файлы в папку `exports/`. **Особенность**: использует файловый кэш с TTL 1 час для избежания повторных запросов к Bitrix24 API при ограничениях. Кэш хранится в папке `cache/`, ключ кэша генерируется на основе параметров запроса (entity, filter_fields, select_fields). При повторном запросе с теми же параметрами данные загружаются из кэша, если он не устарел.
    - `analyze_export_file(file_path, operation, fields, condition, group_by, include_records)` — анализ экспортированных данных с операциями `count`, `sum`, `avg`, `min`, `max`. **Параметр include_records**: если `True`, возвращает массив всех отфильтрованных записей с указанными полями в поле `records` ответа. **Особенность**: если `fields` содержит `["*"]` или `"*"`, возвращаются все поля записей целиком. Если `fields` не указан, также возвращаются все поля. Поддерживает сложные условия фильтрации:
      - Строка с операторами: `'DATE_CREATE >= "2025-11-03 00:00:00" and DATE_CREATE <= "2025-11-09 23:59:59"'`
      - Словарь с операторами: `{'DATE_CREATE': {'>=': '2025-11-03T00:00:00', '<=': '2025-11-09T23:59:59'}}`
      - Словарь с альтернативными операторами: `{'UF_CRM_H_C3_WON': {'gte': '2025-11-10T00:00:00', 'lte': '2025-11-16T23:59:59'}}` (поддерживаются: `gte`/`ge` → `>=`, `lte`/`le` → `<=`, `gt` → `>`, `lt` → `<`, `eq` → `==`, `ne`/`neq` → `!=`)
      - Словарь с операторами в строках: `{'DATE_CREATE': '>= 2025-11-03T00:00:00'}` (автоматически преобразуется)
      - JSON строка: `'{"DATE_CREATE": ">= 2025-11-03T00:00:00"}'` (автоматически распарсивается, поддерживает дублирующиеся ключи)
      - JSON строка с операторами в ключах: `'{"<DEADLINE": "2025-11-10T12:08:36", "!STATUS": "5"}'` (операторы в ключах автоматически извлекаются и преобразуются в нормализованный формат)
    - `analyze_tasks_export(file_path, operation, fields, condition, group_by, include_records)` — специализированный анализ для задач. **Параметр include_records**: если `True`, возвращает массив всех отфильтрованных записей с указанными полями в поле `records` ответа. **Особенность**: если `fields` содержит `["*"]` или `"*"`, возвращаются все поля записей целиком. Если `fields` не указан, также возвращаются все поля. Автоматически преобразует имена полей из формата UPPER_SNAKE_CASE (например, `RESPONSIBLE_ID`, `STATUS`) в camelCase (например, `responsibleId`, `status`) для совместимости с форматом полей в JSON файлах задач. Поддерживает оба формата имен полей в параметрах. Корректно обрабатывает случай, когда `fields` равен `None` (например, для операции `count`).
    - `export_task_fields_to_json(filename)` — экспорт описания полей задач
    - `datetime_now()` — получение текущей даты и времени в московской зоне
    - `prepare_fields_to_humman_format(fields, all_info_fields)` — преобразование технических ключей полей в человеко-читаемые названия
  - Поддерживает сложные условия фильтрации с операторами сравнения и логическими `and`/`or`.
  - Поддерживает сравнение дат с ключевыми словами `today`, `tomorrow`, `yesterday`.
  - Вспомогательные функции для работы с датами:
    - `_parse_datetime(value)` — парсинг дат/времени: ISO-8601, `YYYY-MM-DD`, `YYYY-MM-DD HH:MM:SS`.
    - `_keyword_to_datetime(keyword, tz)` — преобразование ключевых слов `today`/`tomorrow`/`yesterday` в начало соответствующего дня с учётом TZ.
    - `_compare(lhs, op, rhs)` — сравнение чисел, дат/времени и строк; для дат поддерживаются операторы `>`, `>=`, `<`, `<=`. **Особенность**: при сравнении дат naive datetime (без часового пояса) интерпретируются как московское время (Europe/Moscow), aware datetime с разными часовыми поясами конвертируются в московское время для корректного сравнения. **Особенность**: для операторов `<` и `>` с датами без времени (формат `YYYY-MM-DD`) интерпретация следующая: `"< 2025-11-11"` означает "до конца дня 11 ноября" (т.е. `< 2025-11-12 00:00:00`), `"> 2025-11-11"` означает "после конца дня 11 ноября" (т.е. `> 2025-11-11 23:59:59`). Это позволяет корректно обрабатывать условия с несколькими операторами для одного поля даты. **Особенность**: для операторов `==` и `!=` выполняется нормализация типов - если оба значения можно преобразовать в числа, они сравниваются как числа (например, строка `"123"` равна числу `123`).
    - `_normalize_operator(op)` — нормализация операторов: преобразует альтернативные операторы в стандартные (`gte`/`ge` → `>=`, `lte`/`le` → `<=`, `gt` → `>`, `lt` → `<`, `eq` → `==`, `ne`/`neq` → `!=`). Используется для поддержки различных форматов операторов в условиях фильтрации.
    - `_normalize_condition(condition)` — нормализация условий фильтрации: парсит JSON строки, обрабатывает дублирующиеся ключи, преобразует операторы в строках в правильный формат словаря, нормализует альтернативные операторы через `_normalize_operator`. **Особенность**: поддерживает операторы в ключах JSON (`<DEADLINE`, `!STATUS`, `>=DATE`, и т.д.), автоматически извлекает их и преобразует в нормализованный формат. Нормализует имена полей в нижний регистр для совместимости.
    - `_normalize_condition_for_task(condition)` — нормализация условий фильтрации для задач: преобразует имена полей из UPPER_SNAKE_CASE в camelCase для совместимости с форматом полей в JSON файлах задач.
    - `_snake_to_camel(snake_str)` — преобразование UPPER_SNAKE_CASE или lower_snake_case в camelCase (например, `RESPONSIBLE_ID` → `responsibleId`).
    - `_get_field_value_case_insensitive(record, field_name)` — получение значения поля из записи независимо от регистра ключа. Используется для совместимости с данными, где поля могут быть в разных регистрах.
    - `_apply_condition(records, condition)` — применение условия к записям с поддержкой поиска полей без учета регистра. **Особенность**: при наличии нескольких операторов для одного поля (например, `{'DATE_CREATE': {'<=': '2025-11-11 23:59:59', '<': '2025-11-11'}}`) проверяются ВСЕ операторы одновременно (AND логика) - запись проходит фильтр только если все операторы выполняются. **Особенность**: нормализует альтернативные операторы (`gte`, `lte`, `gt`, `lt`, `eq`, `ne`) через `_normalize_operator` перед сравнением. **Особенность**: использует `_compare` для сравнения значений, что обеспечивает нормализацию типов (строка `"123"` сравнивается с числом `123` как равные).
    - `_get_field_value_for_task(record, field_name)` — получение значения поля из записи задачи с поддержкой преобразования UPPER_SNAKE_CASE в camelCase. Используется для анализа задач.
    - `_apply_condition_for_task(records, condition)` — применение условия к записям задач с поддержкой преобразования форматов полей. **Особенность**: нормализует альтернативные операторы (`gte`, `lte`, `gt`, `lt`, `eq`, `ne`) через `_normalize_operator` перед сравнением. **Особенность**: использует `_compare` для сравнения значений, что обеспечивает нормализацию типов (строка `"123"` сравнивается с числом `123` как равные).
    - `_record_matches_simple_expr_for_task(record, expr)` — проверка соответствия записи задачи условию с поддержкой преобразования форматов полей.
    - `_extract_operator_from_key(key)` — извлечение оператора из ключа JSON, если он есть (например, `<DEADLINE` → оператор `<`, поле `DEADLINE`).
  - Функции кэширования для `export_entities_to_json`:
    - `_generate_cache_key(entity, filter_fields, select_fields)` — генерация уникального ключа кэша на основе параметров запроса с использованием MD5 хеша
    - `_get_cache_path(cache_key)` — получение пути к файлу кэша в папке `cache/`
    - `_load_from_cache(cache_key)` — загрузка данных из кэша с проверкой TTL (1 час), возвращает `None` если кэш устарел или отсутствует
    - `_save_to_cache(cache_key, data)` — сохранение данных в кэш с метаданными времени создания
  - Логирование операций с кэшем через `loguru` (уровень `INFO`).

- `fast_bitrix24_mcp/tools/bitrixWork.py`
  - Вспомогательные функции для работы с API Bitrix24.
  - Настройка логирования: уровень логирования библиотеки `fast_bitrix24` установлен на `WARNING` для подавления DEBUG сообщений (используется стандартный модуль `logging`). Логирование проекта через `loguru` настроено на уровень `INFO` с записью в файлы `logs/workBitrix_{time}.log`.
  - Функции для работы с задачами:
    - `get_fields_by_task()` — получение полей задач через `tasks.task.getFields`
    - `get_task_by_id(task_id: int)` — получение задачи по ID через `tasks.task.get`
    - `get_tasks_by_filter(filter_fields: dict, select_fields: list, order: dict)` — получение задач по фильтру с поддержкой сортировки. Использует `get_all()` без параметра `order` (поскольку он не поддерживается библиотекой), с клиентской сортировкой. При ошибке переключается на `call()` с ручной пагинацией. **Особенность**: фильтрация по полю `STATUS` выполняется на клиенте (получает все задачи и фильтрует локально) из-за проблем с Bitrix24 API, остальные фильтры работают на сервере.
    - `create_task(fields: dict)` — создание задачи через `tasks.task.add`
    - `update_task(task_id: int, fields: dict)` — обновление задачи через `tasks.task.update`
    - `delete_task(task_id: int)` — удаление задачи через `tasks.task.delete`
    - Функции для работы с комментариями, чеклистами и учётом времени задач
  - Функции для работы с CRM: сделки, контакты, компании, пользователи.
  - Функции для работы со стадиями:
    - `get_deal_categories()` — получение всех воронок сделок через `crm.dealcategory.list`. Возвращает список словарей с информацией о воронках (ID, NAME и другие поля).
    - `get_deal_stages(entity_id: str = "DEAL_STAGE", category_id: str | None = None)` — получение стадий через `crm.status.list` для указанной сущности и воронки. Если `category_id` указан, возвращаются стадии только для этой воронки. Поддерживает различные типы сущностей: `DEAL_STAGE` (стадии сделок), `LEAD_STATUS` (статусы лидов), `QUOTE_STATUS` (статусы предложений) и т.д. Возвращает список словарей с информацией о стадиях (STATUS_ID, NAME, CATEGORY_ID и другие поля).
    - `get_category_stages(category_id: int)` — получение стадий для конкретной воронки через `crm.status.list` с фильтром по `CATEGORY_ID`. Используется для получения стадий каждой воронки отдельно.
    - `get_all_deal_stages_by_categories(entity_id: str = "DEAL_STAGE")` — получение всех стадий для всех воронок. **Особенность**: получает все стадии через `crm.status.list` без фильтра (общие стадии), затем для каждой воронки пытается получить стадии через `crm.status.list` с фильтром по `CATEGORY_ID`. Если стадии для конкретной воронки не найдены, используются общие стадии. Удаляет дубликаты по комбинации `STATUS_ID` и `CATEGORY_ID`.
    - `get_stage_history(entity_type_id: int, owner_id: int = None, filter_fields: dict = None, select_fields: list[str] = None)` — получение истории движения по стадиям через `crm.stagehistory.list`. Поддерживает типы сущностей: 1 - лид, 2 - сделка, 5 - счет старый, 31 - счет новый. Если `owner_id` указан, фильтрует историю только для этого объекта. Возвращает список словарей с историей стадий (ID, TYPE_ID, OWNER_ID, CREATED_TIME, STAGE_ID/STATUS_ID, STAGE_SEMANTIC_ID/STATUS_SEMANTIC_ID, CATEGORY_ID и другие поля), отсортированный по ID (ASC). **Особенность**: библиотека `fast_bitrix24` не поддерживает параметр `order` в методе `get_all()`, поэтому сортировка выполняется вручную после получения данных.
  - Функции для получения активности пользователей:
    - `get_crm_activities_by_filter(filter_fields: dict, select_fields: list[str])` — получение активностей CRM (звонки, встречи, email-письма) по фильтру через `crm.activity.list`. Обрабатывает типы активностей: `TYPE_ID = '2'` (звонки), `TYPE_ID = '1'` (встречи), `TYPE_ID = '4'` (email). Для звонков анализирует направление: `DIRECTION = '1'` (исходящий), `DIRECTION = '2'` (входящий), `DIRECTION = '0'` (пропущенный). **Кэширование**: результаты кэшируются на 1 час для избежания повторных запросов к API.
    - `get_deal_activities_by_type(deal_id: int | str, from_date: str = None, to_date: str = None)` — получение всех активностей сделки по всем типам с группировкой. Возвращает структурированный словарь с полями: `deal_id` (ID сделки), `total_activities` (общее количество активностей), `by_type` (словарь с группировкой по типам: `meetings` - TYPE_ID=1, `calls` - TYPE_ID=2, `tasks` - TYPE_ID=3, `emails` - TYPE_ID=4, `actions` - TYPE_ID=5, `custom` - TYPE_ID=6), `statistics` (статистика по каждому типу: количество встреч, звонков с разбивкой по направлениям, задач, писем, действий, пользовательских действий), `all_activities` (все активности в одном списке). **Особенность**: активности с `TYPE_ID='6'`, `PROVIDER_ID='CRM_TODO'` и `PROVIDER_TYPE_ID='TODO'` классифицируются как задачи (`tasks`), а не как пользовательские действия (`custom`). Поддерживает фильтрацию по датам через параметры `from_date` и `to_date` (формат: 'YYYY-MM-DD' или 'YYYY-MM-DDTHH:MM:SS'). Использует `get_crm_activities_by_filter` для получения данных, что обеспечивает кэширование на 1 час.
    - `get_leads_by_filter(filter_fields: dict, select_fields: list[str])` — получение лидов по фильтру через `crm.lead.list`.
    - `get_all_entity_comments(entity_type: str, author_id: int, from_date: str, date_filter: dict)` — получение всех комментариев пользователя в сущностях CRM (deal, lead, contact, company). **Особенность**: API Bitrix24 не возвращает комментарии только по `AUTHOR_ID`, поэтому реализован двухэтапный подход: сначала получаются сущности нужного типа с фильтрацией по дате (параметр `date_filter`), затем для каждой сущности запрашиваются комментарии через `crm.timeline.comment.list` с использованием батчей (fast-bitrix24 автоматически разбивает запросы на батчи по 50), после чего выполняется фильтрация по `AUTHOR_ID` на клиенте. **Оптимизация**: использование батчей и фильтрации сущностей по дате значительно ускоряет получение комментариев для больших объемов данных. **Кэширование**: результаты кэшируются на 1 час для избежания повторных запросов к API.
    - `get_calendar_events(from_date: str, to_date: str, owner_id: int)` — получение событий календаря пользователя через секции. **Особенность**: API требует указания секции календаря, поэтому реализован двухэтапный запрос: сначала получаются секции через `calendar.section.get`, затем для каждой секции получаются события через `calendar.event.get`. **Кэширование**: результаты кэшируются на 1 час для избежания повторных запросов к API.
    - `get_manager_full_activity(manager_id: int, days: int)` — получение полной активности менеджера за указанный период. Агрегирует данные из всех источников: активности CRM, задачи, сделки, лиды, события календаря, комментарии. Возвращает структурированный словарь с детальной статистикой по всем типам активности. **Параллельное выполнение запросов**: все независимые запросы выполняются параллельно через `asyncio.gather` (активности CRM, задачи, сделки, лиды, события календаря и комментарии выполняются одновременно), что значительно ускоряет работу функции по сравнению с последовательным выполнением. **Батчинг комментариев**: комментарии получаются батчами через `get_all_comments_batch()` вместо 4 отдельных запросов для каждого типа сущности (deal, lead, contact, company), что дополнительно ускоряет работу. **Фильтрация задач**: задачи фильтруются по `RESPONSIBLE_ID` и дате создания (`>=CREATED_DATE`, `<=CREATED_DATE`) с дополнительной проверкой на клиенте для гарантии корректности. **Кэширование**: полный результат активности кэшируется на 1 час для избежания повторных запросов к API. Ключ кэша генерируется на основе manager_id, days и периода (start_date, end_date).
    - `get_all_managers_activity(days: int, include_inactive: bool, only_inactive: bool)` — получение активности всех менеджеров за указанный период с определением неактивных пользователей. **Оптимизация**: получает все сущности за период один раз (сделки, лиды, задачи, активности CRM), затем группирует их по менеджерам на клиенте. **Батчинг комментариев и параллельные запросы календаря**: комментарии получаются батчами для всех менеджеров одновременно через функцию `get_all_comments_batch()`, события календаря получаются параллельно через `get_all_calendar_events_batch()` (API Bitrix24 не поддерживает батчинг для методов календаря, поэтому используется `asyncio.gather` для параллельного выполнения запросов), что значительно ускоряет работу при большом количестве менеджеров: вместо N*5 последовательных запросов (где N - количество менеджеров, 5 = комментарии для 4 типов сущностей + календарь) выполняется несколько батчей для комментариев и параллельные запросы для календаря. **Параметр only_inactive**: если `True`, возвращает только список неактивных менеджеров без детальной статистики активных. При этом для активных менеджеров пропускается получение комментариев и календаря (проверяется только базовая активность: звонки, встречи, email, задачи, сделки, лиды), что дополнительно ускоряет работу. Возвращает словарь с полями: `period` (период анализа), `summary` (общая статистика: total_managers, active_managers, inactive_managers, и при only_inactive=False также total_calls, total_meetings, total_emails, total_tasks, total_deals, total_leads, total_comments), `managers_activity` (список активных менеджеров с детальной статистикой, только если only_inactive=False), `inactive_managers` (список неактивных менеджеров с информацией: manager_id, name, email, work_position). **Кэширование**: результаты кэшируются на 1 час. Ключ кэша включает days, start_date, end_date, include_inactive и only_inactive.
    - `get_all_comments_batch(date_filter: dict, manager_ids: list[int] = None)` — получение всех комментариев для всех типов сущностей батчами с группировкой по менеджерам. Получает все комментарии для всех типов сущностей (deal, lead, contact, company) одним набором запросов, затем группирует по AUTHOR_ID на клиенте. Возвращает словарь `{manager_id: {'deal': [...], 'lead': [...], 'contact': [...], 'company': [...]}}`.
    - `get_all_calendar_events_batch(from_date: str, to_date: str, manager_ids: list[int])` — получение всех событий календаря для всех менеджеров параллельно с группировкой по owner_id. Получает секции календаря и события для всех менеджеров параллельно через `asyncio.gather` (API Bitrix24 не поддерживает батчинг для `calendar.section.get` и `calendar.event.get`), затем группирует по owner_id на клиенте. Возвращает словарь `{manager_id: [список событий календаря]}`.
  - Функции кэширования активности:
    - `_generate_activity_cache_key(prefix: str, **kwargs)` — генерация уникального ключа кэша на основе параметров запроса с использованием MD5 хеша
    - `_get_cache_path(cache_key: str)` — получение пути к файлу кэша в папке `cache/`
    - `_load_from_cache(cache_key: str)` — загрузка данных из кэша с проверкой TTL (1 час), возвращает `None` если кэш устарел или отсутствует
    - `_save_to_cache(cache_key: str, data: Any)` — сохранение данных в кэш с метаданными времени создания
  - Логирование операций с кэшем через `loguru` (уровень `INFO`).








